From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: mohammed jasem alaajel <xrambad@glomc.net>
Date: Tue, 22 Nov 2022 12:19:26 +0400
Subject: [PATCH] make ensure know that server had abnormal exit + check if
 current thread equals shutdown thread in mc server class


diff --git a/src/main/java/net/minecraft/server/MCUtil.java b/src/main/java/net/minecraft/server/MCUtil.java
index e9f0ddf1a34bf3b0d868b53e4439d9d9851ad4d6..55ecc8bac1c12fd8e19a7758d2a1705cef972dcf 100644
--- a/src/main/java/net/minecraft/server/MCUtil.java
+++ b/src/main/java/net/minecraft/server/MCUtil.java
@@ -355,6 +355,11 @@ public final class MCUtil {
      */
     public static <T> T ensureMain(String reason, Supplier<T> run) {
         if (!isMainThread()) {
+            // MultiPaper Start - must check if server had abnormal exit + current thread is shutdown thread.
+            if (Thread.currentThread() == MinecraftServer.getServer().shutdownThread && MinecraftServer.getServer().abnormalExit) {
+                return run.get();
+            }
+            // MultiPaper end
             if (reason != null) {
                 new IllegalStateException("Asynchronous " + reason + "! Blocking thread until it returns ").printStackTrace();
             }
